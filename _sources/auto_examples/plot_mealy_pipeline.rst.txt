.. note::
    :class: sphx-glr-download-link-note

    Click :ref:`here <sphx_glr_download_auto_examples_plot_mealy_pipeline.py>` to download the full example code
.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_plot_mealy_pipeline.py:


Model Error Analysis with scikit-learn Pipeline for the Adult income dataset
============================================================================

Here we train a RandomForestClassifier to predict whether a person gains
more or less than 50k per year. This is our primary model.
Before training the primary model we preprocess the categorical and numeric
features of the dataset by means of a scikit-learn Pipeline.
Then we build a secondary model, called Model Performance Predictor (MPP),
to predict on what samples the primary model returns wrong or correct predictions.
The MPP is a DecisionTree returning a binary outcome success/failure. The leaf nodes
yielding failure outcome gather the samples mis-predicted by the primary
model. Plotting the feature distributions of these samples and comparing
to the whole data highlights the subpopulations where the model works poorly.

When using a python notebook, set ``%matplotlib inline`` to enable display.

Those are the necessary imports and initializations.


.. code-block:: python3


    from sklearn.model_selection import train_test_split
    from sklearn.ensemble import RandomForestClassifier
    from sklearn.compose import ColumnTransformer
    from sklearn.preprocessing import StandardScaler, OneHotEncoder
    from sklearn.impute import SimpleImputer
    from sklearn.pipeline import Pipeline

    import pandas as pd
    import numpy as np
    import random

    import matplotlib.image as mpimg
    import matplotlib.pyplot as plt

    from mealy.error_analyzer import ErrorAnalyzer
    from mealy.error_visualizer import ErrorVisualizer


    default_seed = 10
    np.random.seed(default_seed)
    random.seed(default_seed)








Load Adult income dataset.


.. code-block:: python3


    adult_income_url = 'https://www.openml.org/data/get_csv/54002/adult-census.arff'

    df = pd.read_csv(adult_income_url)

    row_id = 'ID'
    df = df.drop([row_id], axis=1)

    target = 'class'


    X = df.dropna().drop(target, axis=1)
    y = df.dropna()[target]

    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2)

    numeric_features = df.select_dtypes(include=['int64', 'float64']).columns.tolist()
    categorical_features = df.select_dtypes(include=['object']).drop([target], axis=1).columns.tolist()

    feature_names = numeric_features + categorical_features

    print('Categorical features of the adult dataset:')
    print(categorical_features)
    print('Numeric features of the adult dataset:')
    print(numeric_features)





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Categorical features of the adult dataset:
    ['workclass', 'education:', 'marital-status:', 'occupation:', 'relationship:', 'race:', 'sex:', 'native-country:']
    Numeric features of the adult dataset:
    ['age', 'fnlwgt:', 'education-num:', 'capital-gain:', 'capital-loss:', 'hours-per-week:']




Build the preprocessing Pipeline.
#############################################################################
 The final Pipeline should contain a `sklearn.compose.ColumnTransformer` as a
 preprocessor and any `sklearn.base.BaseEstimator` as the primary model to
 investigate.


.. code-block:: python3


    numeric_transformer = Pipeline(steps=[
        ('imputer', SimpleImputer(strategy='median')),
        ('scaler', StandardScaler())])
    categorical_transformer = Pipeline(steps=[
        ('imputer', SimpleImputer(strategy='constant', fill_value='missing')),
        ('onehot', OneHotEncoder(handle_unknown='ignore'))])

    preprocessor = ColumnTransformer(
        transformers=[
            ('num', numeric_transformer, numeric_features),
            ('cat', categorical_transformer, categorical_features)])

    model = Pipeline(steps=[('preprocessor', preprocessor),
                            ('classifier', RandomForestClassifier())])








Train preprocessing Pipeline and RandomForestClassifier.


.. code-block:: python3


    model.fit(X_train, y_train)

    acc_score = model.score(X_test, y_test)
    print("Acc = %.2f" % acc_score)





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Acc = 0.84




Fit a Model Performance Predictor on the model performances.


.. code-block:: python3


    error_analyzer = ErrorAnalyzer(model, feature_names=feature_names)
    error_analyzer.fit(X_test, y_test)








Print metrics regarding the Model Performance Predictor.


.. code-block:: python3


    print(error_analyzer.mpp_summary(X_test, y_test, output_dict=False))





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    The MPP was trained with accuracy 88.33% and balanced accuracy 70.62%.
    The Decision Tree estimated the primary models accuracy to 89.90%.
    The true accuracy of the primary model is 84.49.%
    The Fidelity of the MPP is 94.60%.
    The MPP is considered representative of the primary model performances.





Plot the Model Performance Predictor Decision Tree.


.. code-block:: python3


    error_visualizer = ErrorVisualizer(error_analyzer)
    tree_src = error_visualizer.plot_error_tree()

    # the output of ``plot_error_tree`` is rendered automatically in a python notebook with sliders
    # the following is for rendering in this sphinx gallery
    tree_src.format = 'png'
    tree_src.render('tree')
    tree_img = mpimg.imread('tree.png')

    plt.figure(figsize=(50, 50))
    plt.imshow(tree_img, origin='upper')
    plt.xlim(8000, 9500);
    plt.ylim(4500, 3500);
    plt.axis('off')




.. image:: /auto_examples/images/sphx_glr_plot_mealy_pipeline_001.png
    :class: sphx-glr-single-img





Print the details regarding the decision tree nodes containing the majority of errors.


.. code-block:: python3


    error_analyzer.error_node_summary(leaf_selector="all_errors", add_path_to_leaves=True, print_summary=True);





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    LEAF 484:
         Correct predictions: 1 | Wrong predictions: 13 | Local error (purity): 0.93 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: > 285964.00
                                             occupation: != Machine-op-inspct
                                                fnlwgt: <= 318882.50
                                                   fnlwgt: > 310547.00
    LEAF 345:
         Correct predictions: 0 | Wrong predictions: 10 | Local error (purity): 1.00 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age <= -0.15
                                                         education-num: > 9.50
                                                            fnlwgt: > 78978.00
                                                               fnlwgt: <= 187010.50
                                                                  fnlwgt: <= 178258.00
                                                                     occupation: != Exec-managerial
                                                                        fnlwgt: <= 133428.50
                                                                           fnlwgt: > 113453.50
    LEAF 419:
         Correct predictions: 0 | Wrong predictions: 10 | Local error (purity): 1.00 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age > -0.15
                                                         age <= 0.87
                                                            age > 0.58
                                                               workclass != Private
                                                                  fnlwgt: > 121093.50
                                                                     hours-per-week: <= 48.00
    LEAF 506:
         Correct predictions: 1 | Wrong predictions: 10 | Local error (purity): 0.91 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass == State-gov
                                       education: != HS-grad
                                          fnlwgt: > 294819.50
    LEAF 425:
         Correct predictions: 1 | Wrong predictions: 9 | Local error (purity): 0.90 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age > -0.15
                                                         age <= 0.87
                                                            age > 0.58
                                                               workclass == Private
                                                                  fnlwgt: <= 183395.00
                                                                     fnlwgt: <= 121589.00
                                                                        fnlwgt: > 105388.00
    LEAF 373:
         Correct predictions: 3 | Wrong predictions: 16 | Local error (purity): 0.84 | Global error: 0.02
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age > -0.15
                                                         age <= 0.87
                                                            age <= 0.58
                                                               age <= 0.07
                                                                  occupation: != Craft-repair
                                                                     fnlwgt: > 147541.50
                                                                        hours-per-week: <= 45.50
                                                                           fnlwgt: > 188421.50
    LEAF 406:
         Correct predictions: 4 | Wrong predictions: 15 | Local error (purity): 0.79 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age > -0.15
                                                         age <= 0.87
                                                            age <= 0.58
                                                               age > 0.07
                                                                  fnlwgt: <= 203903.50
                                                                     occupation: == Sales
                                                                        hours-per-week: <= 49.50
    LEAF 350:
         Correct predictions: 2 | Wrong predictions: 10 | Local error (purity): 0.83 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age <= -0.15
                                                         education-num: > 9.50
                                                            fnlwgt: > 78978.00
                                                               fnlwgt: <= 187010.50
                                                                  fnlwgt: > 178258.00
    LEAF 285:
         Correct predictions: 2 | Wrong predictions: 8 | Local error (purity): 0.80 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: <= 32.50
                                    relationship: == Wife
                                       education-num: > 9.50
                                          age <= -0.23
    LEAF 420:
         Correct predictions: 2 | Wrong predictions: 8 | Local error (purity): 0.80 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age > -0.15
                                                         age <= 0.87
                                                            age > 0.58
                                                               workclass != Private
                                                                  fnlwgt: > 121093.50
                                                                     hours-per-week: > 48.00
    LEAF 463:
         Correct predictions: 2 | Wrong predictions: 8 | Local error (purity): 0.80 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age > -0.15
                                                         age > 0.87
                                                            education: == HS-grad
                                                               fnlwgt: <= 174378.50
                                                                  occupation: != Sales
                                                                     age > 1.46
                                                                        age <= 1.68
    LEAF 540:
         Correct predictions: 2 | Wrong predictions: 8 | Local error (purity): 0.80 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: > 13.50
                                 age > 1.68
    LEAF 153:
         Correct predictions: 4 | Wrong predictions: 13 | Local error (purity): 0.76 | Global error: 0.01
         Path to leaf:
         marital-status: != Married-civ-spouse
            education-num: > 12.50
               age > -0.81
                  capital-gain: <= 4826.00
                     age <= 0.65
                        hours-per-week: > 49.00
                           age <= 0.21
                              fnlwgt: <= 194199.50
                                 workclass == Private
    LEAF 388:
         Correct predictions: 4 | Wrong predictions: 13 | Local error (purity): 0.76 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age > -0.15
                                                         age <= 0.87
                                                            age <= 0.58
                                                               age > 0.07
                                                                  fnlwgt: <= 203903.50
                                                                     occupation: != Sales
                                                                        fnlwgt: > 65609.50
                                                                           fnlwgt: <= 118871.00
                                                                              age <= 0.36
    LEAF 431:
         Correct predictions: 4 | Wrong predictions: 13 | Local error (purity): 0.76 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age > -0.15
                                                         age <= 0.87
                                                            age > 0.58
                                                               workclass == Private
                                                                  fnlwgt: > 183395.00
                                                                     education: == HS-grad
    LEAF 471:
         Correct predictions: 4 | Wrong predictions: 12 | Local error (purity): 0.75 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: > 2994.00
    LEAF 482:
         Correct predictions: 5 | Wrong predictions: 13 | Local error (purity): 0.72 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: > 285964.00
                                             occupation: != Machine-op-inspct
                                                fnlwgt: <= 318882.50
                                                   fnlwgt: <= 310547.00
                                                      fnlwgt: <= 303151.00
    LEAF 367:
         Correct predictions: 4 | Wrong predictions: 11 | Local error (purity): 0.73 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age > -0.15
                                                         age <= 0.87
                                                            age <= 0.58
                                                               age <= 0.07
                                                                  occupation: != Craft-repair
                                                                     fnlwgt: <= 147541.50
                                                                        education-num: <= 10.50
                                                                           fnlwgt: <= 101001.00
    LEAF 174:
         Correct predictions: 5 | Wrong predictions: 11 | Local error (purity): 0.69 | Global error: 0.01
         Path to leaf:
         marital-status: != Married-civ-spouse
            education-num: > 12.50
               age > -0.81
                  capital-gain: <= 4826.00
                     age > 0.65
                        age <= 1.90
                           native-country: == United-States
                              education-num: <= 14.50
                                 workclass == Private
                                    occupation: == Exec-managerial
    LEAF 396:
         Correct predictions: 4 | Wrong predictions: 10 | Local error (purity): 0.71 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age > -0.15
                                                         age <= 0.87
                                                            age <= 0.58
                                                               age > 0.07
                                                                  fnlwgt: <= 203903.50
                                                                     occupation: != Sales
                                                                        fnlwgt: > 65609.50
                                                                           fnlwgt: > 118871.00
                                                                              hours-per-week: <= 51.00
                                                                                 fnlwgt: <= 179256.50
                                                                                    fnlwgt: <= 170772.50
                                                                                       fnlwgt: > 143213.50
                                                                                          fnlwgt: <= 159309.50
    LEAF 535:
         Correct predictions: 3 | Wrong predictions: 9 | Local error (purity): 0.75 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: > 13.50
                                 age <= 1.68
                                    fnlwgt: > 204566.50
                                       fnlwgt: <= 343731.50
                                          hours-per-week: <= 46.50
                                             workclass == Private
    LEAF 312:
         Correct predictions: 3 | Wrong predictions: 8 | Local error (purity): 0.73 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: != White
                                          occupation: == Exec-managerial
                                             education-num: <= 11.50
    LEAF 460:
         Correct predictions: 3 | Wrong predictions: 8 | Local error (purity): 0.73 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age > -0.15
                                                         age > 0.87
                                                            education: == HS-grad
                                                               fnlwgt: <= 174378.50
                                                                  occupation: != Sales
                                                                     age <= 1.46
                                                                        fnlwgt: > 123891.00
                                                                           fnlwgt: <= 148030.00
    LEAF 265:
         Correct predictions: 3 | Wrong predictions: 7 | Local error (purity): 0.70 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age <= -0.67
                        education: == Bachelors
                           hours-per-week: > 44.50
                              fnlwgt: > 186679.00
    LEAF 400:
         Correct predictions: 3 | Wrong predictions: 7 | Local error (purity): 0.70 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age > -0.15
                                                         age <= 0.87
                                                            age <= 0.58
                                                               age > 0.07
                                                                  fnlwgt: <= 203903.50
                                                                     occupation: != Sales
                                                                        fnlwgt: > 65609.50
                                                                           fnlwgt: > 118871.00
                                                                              hours-per-week: <= 51.00
                                                                                 fnlwgt: > 179256.50
                                                                                    fnlwgt: <= 187453.00
    LEAF 494:
         Correct predictions: 6 | Wrong predictions: 12 | Local error (purity): 0.67 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: > 285964.00
                                             occupation: != Machine-op-inspct
                                                fnlwgt: > 318882.50
                                                   occupation: != Prof-specialty
                                                      workclass != Self-emp-not-inc
                                                         hours-per-week: > 41.00
                                                            age <= 0.07
    LEAF 497:
         Correct predictions: 5 | Wrong predictions: 10 | Local error (purity): 0.67 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: > 285964.00
                                             occupation: != Machine-op-inspct
                                                fnlwgt: > 318882.50
                                                   occupation: == Prof-specialty
    LEAF 175:
         Correct predictions: 5 | Wrong predictions: 8 | Local error (purity): 0.62 | Global error: 0.01
         Path to leaf:
         marital-status: != Married-civ-spouse
            education-num: > 12.50
               age > -0.81
                  capital-gain: <= 4826.00
                     age > 0.65
                        age <= 1.90
                           native-country: == United-States
                              education-num: > 14.50
    LEAF 303:
         Correct predictions: 5 | Wrong predictions: 8 | Local error (purity): 0.62 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: != White
                                          occupation: != Exec-managerial
                                             age <= 0.50
                                                education: == Some-college
                                                   fnlwgt: > 204691.50
    LEAF 348:
         Correct predictions: 4 | Wrong predictions: 7 | Local error (purity): 0.64 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age <= -0.15
                                                         education-num: > 9.50
                                                            fnlwgt: > 78978.00
                                                               fnlwgt: <= 187010.50
                                                                  fnlwgt: <= 178258.00
                                                                     occupation: != Exec-managerial
                                                                        fnlwgt: > 133428.50
                                                                           fnlwgt: > 158504.50
    LEAF 438:
         Correct predictions: 4 | Wrong predictions: 7 | Local error (purity): 0.64 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age > -0.15
                                                         age > 0.87
                                                            education: != HS-grad
                                                               fnlwgt: <= 176539.50
                                                                  fnlwgt: > 75006.00
                                                                     fnlwgt: <= 140027.50
                                                                        age <= 1.02
    LEAF 451:
         Correct predictions: 6 | Wrong predictions: 9 | Local error (purity): 0.60 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age > -0.15
                                                         age > 0.87
                                                            education: != HS-grad
                                                               fnlwgt: > 176539.50
                                                                  age > 1.46
    LEAF 505:
         Correct predictions: 4 | Wrong predictions: 7 | Local error (purity): 0.64 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass == State-gov
                                       education: != HS-grad
                                          fnlwgt: <= 294819.50
                                             education-num: > 11.50
                                                fnlwgt: > 129947.00
    LEAF 568:
         Correct predictions: 5 | Wrong predictions: 8 | Local error (purity): 0.62 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: > 1836.50
                     capital-loss: > 2054.00
                        capital-loss: <= 2372.00
    LEAF 107:
         Correct predictions: 5 | Wrong predictions: 7 | Local error (purity): 0.58 | Global error: 0.01
         Path to leaf:
         marital-status: != Married-civ-spouse
            education-num: <= 12.50
               age > -0.74
                  hours-per-week: > 45.50
                     fnlwgt: > 339189.50
                        fnlwgt: <= 390427.00
    LEAF 196:
         Correct predictions: 4 | Wrong predictions: 6 | Local error (purity): 0.60 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: <= 8.50
                  hours-per-week: > 27.50
                     fnlwgt: <= 188742.00
                        fnlwgt: > 152677.00
                           fnlwgt: <= 158665.50
    LEAF 328:
         Correct predictions: 4 | Wrong predictions: 6 | Local error (purity): 0.60 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age <= -0.15
                                                         education-num: <= 9.50
                                                            hours-per-week: <= 49.50
                                                               workclass == Private
                                                                  fnlwgt: > 64599.50
                                                                     fnlwgt: <= 221483.00
                                                                        occupation: != Craft-repair
                                                                           fnlwgt: <= 152570.00
    LEAF 359:
         Correct predictions: 4 | Wrong predictions: 6 | Local error (purity): 0.60 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age <= -0.15
                                                         education-num: > 9.50
                                                            fnlwgt: > 78978.00
                                                               fnlwgt: > 187010.50
                                                                  fnlwgt: > 201641.00
                                                                     education-num: > 12.50
                                                                        fnlwgt: > 231560.00
    LEAF 372:
         Correct predictions: 6 | Wrong predictions: 8 | Local error (purity): 0.57 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age > -0.15
                                                         age <= 0.87
                                                            age <= 0.58
                                                               age <= 0.07
                                                                  occupation: != Craft-repair
                                                                     fnlwgt: > 147541.50
                                                                        hours-per-week: <= 45.50
                                                                           fnlwgt: <= 188421.50
    LEAF 376:
         Correct predictions: 4 | Wrong predictions: 6 | Local error (purity): 0.60 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age > -0.15
                                                         age <= 0.87
                                                            age <= 0.58
                                                               age <= 0.07
                                                                  occupation: == Craft-repair
                                                                     fnlwgt: <= 121011.50
    LEAF 457:
         Correct predictions: 6 | Wrong predictions: 8 | Local error (purity): 0.57 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age > -0.15
                                                         age > 0.87
                                                            education: == HS-grad
                                                               fnlwgt: <= 174378.50
                                                                  occupation: != Sales
                                                                     age <= 1.46
                                                                        fnlwgt: <= 123891.00
                                                                           fnlwgt: <= 100347.00
    LEAF 464:
         Correct predictions: 4 | Wrong predictions: 6 | Local error (purity): 0.60 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age > -0.15
                                                         age > 0.87
                                                            education: == HS-grad
                                                               fnlwgt: <= 174378.50
                                                                  occupation: != Sales
                                                                     age > 1.46
                                                                        age > 1.68
    LEAF 470:
         Correct predictions: 7 | Wrong predictions: 9 | Local error (purity): 0.56 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age > -0.15
                                                         age > 0.87
                                                            education: == HS-grad
                                                               fnlwgt: > 174378.50
                                                                  fnlwgt: > 208152.50
    LEAF 504:
         Correct predictions: 4 | Wrong predictions: 6 | Local error (purity): 0.60 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass == State-gov
                                       education: != HS-grad
                                          fnlwgt: <= 294819.50
                                             education-num: > 11.50
                                                fnlwgt: <= 129947.00
    LEAF 546:
         Correct predictions: 4 | Wrong predictions: 6 | Local error (purity): 0.60 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: == Farming-fishing
                              fnlwgt: <= 214623.00
                                 fnlwgt: > 79831.50
                                    hours-per-week: > 52.00
    LEAF 264:
         Correct predictions: 7 | Wrong predictions: 8 | Local error (purity): 0.53 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age <= -0.67
                        education: == Bachelors
                           hours-per-week: > 44.50
                              fnlwgt: <= 186679.00
    LEAF 333:
         Correct predictions: 9 | Wrong predictions: 10 | Local error (purity): 0.53 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age <= -0.15
                                                         education-num: <= 9.50
                                                            hours-per-week: > 49.50
                                                               fnlwgt: <= 164102.00
    LEAF 344:
         Correct predictions: 9 | Wrong predictions: 10 | Local error (purity): 0.53 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: <= 285964.00
                                             fnlwgt: <= 275148.00
                                                capital-gain: <= 3120.00
                                                   capital-gain: <= 2994.00
                                                      age <= -0.15
                                                         education-num: > 9.50
                                                            fnlwgt: > 78978.00
                                                               fnlwgt: <= 187010.50
                                                                  fnlwgt: <= 178258.00
                                                                     occupation: != Exec-managerial
                                                                        fnlwgt: <= 133428.50
                                                                           fnlwgt: <= 113453.50
    LEAF 492:
         Correct predictions: 9 | Wrong predictions: 10 | Local error (purity): 0.53 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: <= 13.50
                                 hours-per-week: > 32.50
                                    workclass != State-gov
                                       race: == White
                                          fnlwgt: > 285964.00
                                             occupation: != Machine-op-inspct
                                                fnlwgt: > 318882.50
                                                   occupation: != Prof-specialty
                                                      workclass != Self-emp-not-inc
                                                         hours-per-week: <= 41.00
                                                            age > -0.01
    LEAF 515:
         Correct predictions: 5 | Wrong predictions: 6 | Local error (purity): 0.55 | Global error: 0.01
         Path to leaf:
         marital-status: == Married-civ-spouse
            capital-gain: <= 5095.50
               education-num: > 8.50
                  capital-loss: <= 1836.50
                     age > -0.67
                        age <= 2.04
                           occupation: != Farming-fishing
                              education-num: > 13.50
                                 age <= 1.68
                                    fnlwgt: <= 204566.50
                                       occupation: != Exec-managerial
                                          occupation: != Prof-specialty
                                             age <= 0.50




Plot the feature distributions of samples in the leaf containing the majority of errors.
Rank features by correlation to error.


.. code-block:: python3

    leaf_id = error_analyzer.get_ranked_leaf_ids('all_errors')[0]
    error_visualizer.plot_feature_distributions_on_leaves(leaf_selector=leaf_id, top_k_features=3)




.. rst-class:: sphx-glr-horizontal


    *

      .. image:: /auto_examples/images/sphx_glr_plot_mealy_pipeline_002.png
            :class: sphx-glr-multi-img

    *

      .. image:: /auto_examples/images/sphx_glr_plot_mealy_pipeline_003.png
            :class: sphx-glr-multi-img

    *

      .. image:: /auto_examples/images/sphx_glr_plot_mealy_pipeline_004.png
            :class: sphx-glr-multi-img


.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Leaf 484 (Wrong prediction: 0.929, Correct prediction: 0.071)




Discussion
----------

Model Performance Predictor Metrics
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

We are dealing with a binary classification task.
Here the primary predictions of "income less or more than 50k" have been categorized
in two classes: 'Correct prediction' and 'Wrong prediction' according to the difference
from the true class. The accuracy is then the number of Correct predictions over the total.
The MPP might not be representative of the behavior of the primary model as the true primary
accuracy and the one estimated by the MPP are not close.

Model Failures
^^^^^^^^^^^^^^

Let's focus on the nodes of the MPP DecisionTree, in particular the leaf nodes
of class 'Wrong prediction'. These leaves contain the majority of errors, each
leaf clustering a subpopulation of errors with different feature values. The largest
and purest failure nodes are highlighted when printing the error node summary, and
also when plotting the feature distributions in the node (``leaf_selector="all_errors"``).
From the feature distributions, sorted by correlation with the error, we can see that
the majority of problems occur for married people.
In the next iteration of model design, the primary model needs to be improved for these
subpopulations.



.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  40.340 seconds)

**Estimated memory usage:**  2205 MB


.. _sphx_glr_download_auto_examples_plot_mealy_pipeline.py:


.. only :: html

 .. container:: sphx-glr-footer
    :class: sphx-glr-footer-example



  .. container:: sphx-glr-download

     :download:`Download Python source code: plot_mealy_pipeline.py <plot_mealy_pipeline.py>`



  .. container:: sphx-glr-download

     :download:`Download Jupyter notebook: plot_mealy_pipeline.ipynb <plot_mealy_pipeline.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
