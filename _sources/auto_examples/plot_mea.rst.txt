.. note::
    :class: sphx-glr-download-link-note

    Click :ref:`here <sphx_glr_download_auto_examples_plot_mea.py>` to download the full example code
.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_plot_mea.py:


Model Error Analysis for the Boston houses dataset
===================================================================

Here we train a RandomForestRegressor to predict the price of the houses
in Boston. This is our primary model. Then we build a secondary model,
called Model Performance Predictor (MPP), to predict on what samples
the primary model returns wrong or correct predictions. The MPP is a
DecisionTree returning a binary outcome success/failure. The leaf nodes
yielding failure outcome gather the samples mis-predicted by the primary
model. Plotting the feature distributions of these samples and comparing
to the whole data highlights the subpopulations where the model works poorly.

Those are the necessary imports and initializations


.. code-block:: python3


    from sklearn.datasets import load_boston
    from sklearn.model_selection import train_test_split
    from sklearn.ensemble import RandomForestRegressor

    import numpy as np

    from mea.error_analyzer import ErrorAnalyzer
    from mea.error_visualizer import ErrorVisualizer

    np.random.seed(100)








Load Boston houses dataset


.. code-block:: python3


    dataset = load_boston()
    X = dataset.data
    y = dataset.target
    feature_names = dataset.feature_names

    X_train, X_test, y_train, y_test = train_test_split(X, y)








Train a RandomForestRegressor


.. code-block:: python3


    model = RandomForestRegressor()
    model.fit(X_train, y_train)

    r2_score = model.score(X_test, y_test)
    print("R2 = %.2f" % r2_score)





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    R2 = 0.87




Fit a Model Performance Predictor on the model performances


.. code-block:: python3


    error_analyzer = ErrorAnalyzer(model, feature_names=feature_names)
    error_analyzer.fit(X_test, y_test)








Print metrics regarding the Model Performance Predictor


.. code-block:: python3


    print(error_analyzer.mpp_summary(X_test, y_test, output_dict=False))





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    The MPP was trained with accuracy 96.85%.
    The Decision Tree estimated the primary models accuracy to 91.34%.
    The true accuracy of the primary model is 88.19.%
    The Fidelity of the MPP is 96.85%.
    The MPP is considered representative of the primary model performances.





Plot the Model Performance Predictor Decision Tree


.. code-block:: python3


    error_visualizer = ErrorVisualizer(error_analyzer)
    error_visualizer.plot_error_tree(size=(5, 5))





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none


    <graphviz.files.Source object at 0x12c3ebe80>



Print the details regarding the decision tree nodes containing the majority of errors


.. code-block:: python3


    error_analyzer.error_node_summary(leaf_selector="all_errors", add_path_to_leaves=True, print_summary=True);





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    LEAF 2:
         Correct predictions: 0 | Wrong predictions: 5 | Local error (purity): 1.00 | Global error: 0.33
         Path to leaf:
         DIS <= 1.51
            LSTAT <= 20.78
    LEAF 17:
         Correct predictions: 0 | Wrong predictions: 3 | Local error (purity): 1.00 | Global error: 0.20
         Path to leaf:
         DIS > 1.51
            RM > 8.00
               NOX <= 0.59
    LEAF 14:
         Correct predictions: 0 | Wrong predictions: 2 | Local error (purity): 1.00 | Global error: 0.13
         Path to leaf:
         DIS > 1.51
            RM <= 8.00
               NOX > 0.51
                  DIS > 2.89
                     DIS <= 3.34
    LEAF 5:
         Correct predictions: 0 | Wrong predictions: 1 | Local error (purity): 1.00 | Global error: 0.07
         Path to leaf:
         DIS <= 1.51
            LSTAT > 20.78
               DIS > 1.47

    [{'id': 2, 'n_corrects': 0.0, 'n_errors': 5.0, 'local_error': 1.0, 'global_error': 0.3333333333333333, 'path_to_leaf': deque(['DIS <= 1.51', 'LSTAT <= 20.78'])}, {'id': 17, 'n_corrects': 0.0, 'n_errors': 3.0, 'local_error': 1.0, 'global_error': 0.2, 'path_to_leaf': deque(['DIS > 1.51', 'RM > 8.00', 'NOX <= 0.59'])}, {'id': 14, 'n_corrects': 0.0, 'n_errors': 2.0, 'local_error': 1.0, 'global_error': 0.13333333333333333, 'path_to_leaf': deque(['DIS > 1.51', 'RM <= 8.00', 'NOX > 0.51', 'DIS > 2.89', 'DIS <= 3.34'])}, {'id': 5, 'n_corrects': 0.0, 'n_errors': 1.0, 'local_error': 1.0, 'global_error': 0.06666666666666667, 'path_to_leaf': deque(['DIS <= 1.51', 'LSTAT > 20.78', 'DIS > 1.47'])}]



Plot the feature distributions of samples in the nodes containing the majority of errors
Rank features by correlation to error


.. code-block:: python3


    error_visualizer.plot_feature_distributions_on_leaves(leaf_selector="all_errors", top_k_features=3)




.. rst-class:: sphx-glr-horizontal


    *

      .. image:: /auto_examples/images/sphx_glr_plot_mea_001.png
            :class: sphx-glr-multi-img

    *

      .. image:: /auto_examples/images/sphx_glr_plot_mea_002.png
            :class: sphx-glr-multi-img

    *

      .. image:: /auto_examples/images/sphx_glr_plot_mea_003.png
            :class: sphx-glr-multi-img

    *

      .. image:: /auto_examples/images/sphx_glr_plot_mea_004.png
            :class: sphx-glr-multi-img

    *

      .. image:: /auto_examples/images/sphx_glr_plot_mea_005.png
            :class: sphx-glr-multi-img

    *

      .. image:: /auto_examples/images/sphx_glr_plot_mea_006.png
            :class: sphx-glr-multi-img

    *

      .. image:: /auto_examples/images/sphx_glr_plot_mea_007.png
            :class: sphx-glr-multi-img

    *

      .. image:: /auto_examples/images/sphx_glr_plot_mea_008.png
            :class: sphx-glr-multi-img

    *

      .. image:: /auto_examples/images/sphx_glr_plot_mea_009.png
            :class: sphx-glr-multi-img

    *

      .. image:: /auto_examples/images/sphx_glr_plot_mea_010.png
            :class: sphx-glr-multi-img

    *

      .. image:: /auto_examples/images/sphx_glr_plot_mea_011.png
            :class: sphx-glr-multi-img

    *

      .. image:: /auto_examples/images/sphx_glr_plot_mea_012.png
            :class: sphx-glr-multi-img


.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Leaf 2 (Wrong prediction: 1.000, Correct prediction: 0.000)
    Leaf 17 (Wrong prediction: 1.000, Correct prediction: 0.000)
    Leaf 14 (Wrong prediction: 1.000, Correct prediction: 0.000)
    Leaf 5 (Wrong prediction: 1.000, Correct prediction: 0.000)




Discussion
----------

Model Performance Predictor Metrics
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

We are dealing with a regression task, but the metrics highlight the accuracy
of the primary model and its estimate given by the Model Performance Predictor.
Here the primary predictions of price have been categorized in two classes:
'Correct prediction' and 'Wrong prediction' by thresholding the deviation of
the prediction from the true value. Close enough predictions are Correct prediction,
the others are Wrong prediction. For more details, have a look at the documentation.
The accuracy is then the number of Correct predictions over the total.
The MPP is representative of the behavior of the primary model as the true primary
accuracy and the one estimated by the MPP are close.

Model Failures
^^^^^^^^^^^^^^

Let's focus on the nodes of the MPP DecisionTree, in particular the leaf nodes
of class 'Wrong prediction'. These leaves contain the majority of errors, each
leaf clustering a subpopulation of errors with different feature values. The largest
and purest failure nodes are highlighted when printing the error node summary, and
also when plotting the feature distributions in the node (``leaf_selector="all_errors"``).
From the feature distributions, sorted by correlation with the error, we can see that
the majority of problems occur for extreme values of features ``DIS`` and ``TAX``.
In the next iteration of model design, the primary model needs to be improved for these
subpopulations.



.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  6.620 seconds)

**Estimated memory usage:**  104 MB


.. _sphx_glr_download_auto_examples_plot_mea.py:


.. only :: html

 .. container:: sphx-glr-footer
    :class: sphx-glr-footer-example



  .. container:: sphx-glr-download

     :download:`Download Python source code: plot_mea.py <plot_mea.py>`



  .. container:: sphx-glr-download

     :download:`Download Jupyter notebook: plot_mea.ipynb <plot_mea.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
